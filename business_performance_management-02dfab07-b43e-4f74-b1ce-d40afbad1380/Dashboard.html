<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .sidebar { position: fixed; left: 0; top: 0; width: 200px; height: 100%; background: #333; color: #FFF; padding: 15px; box-shadow: 3px 0 5px rgba(0,0,0,0.1); }
        .sidebar a { color: #FFF; text-decoration: none; display: block; margin: 10px 0; }
        .main-content { margin-left: 220px; padding: 20px; }
        .card { background-color: #f2f2f2; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        input[type="date"] { margin: 0 10px; padding: 5px; }
    </style>
</head>
<body>
<div class="sidebar">
    <a href="Dashboard.html">Dashboard</a>
    <a href="PatientManagement.html">Patient Management</a>
    <a href="AppointmentandSchedulingManagement.html">Appointment & Scheduling</a>
    <a href="ClinicalPerformanceMetrics.html">Clinical Performance</a>
    <a href="Login.html" onclick="logout()">Logout</a>
</div>
<div class="main-content">
    <h2>Dashboard</h2>
    <label for="startdate">Start Date:</label>
    <input type="date" id="startdate">
    <label for="enddate">End Date:</label>
    <input type="date" id="enddate">
    <button onclick="getData()">Get Data</button>
    <div id="dashboardData"></div>
</div>

<script>
function formatDate(date) {
    const d = new Date(date);
    return d.toISOString().split('T')[0];
}

function loadDashboardData() {
    let startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    let endDate = new Date();
    document.getElementById('startdate').value = formatDate(startDate);
    document.getElementById('enddate').value = formatDate(endDate);
    getData();
}

function handleApiResponse(response, message) {
    if (response.status === 204) document.getElementById('dashboardData').innerHTML = message;
    if (response.status === 400) document.getElementById('dashboardData').innerHTML = 'Bad Request';
    return response.json();
}

function fetchApi(url, message) {
    return fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Request-Key': localStorage.getItem('request_key')
        }
    }).then(response => handleApiResponse(response, message));
}

function getData() {
    var startdate = document.getElementById('startdate').value;
    var enddate = document.getElementById('enddate').value;
    var practice_id = localStorage.getItem('practice_id');
    let dashboardData = document.getElementById('dashboardData');

    const urls = [
        `https://api.sikkasoft.com/v4/kpis/total_production?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`,
        `https://api.sikkasoft.com/v4/kpis/adjusted_production_by_dentist?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`,
        `https://api.sikkasoft.com/v4/kpis/adjusted_production_by_hygienist?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`,
        `https://api.sikkasoft.com/v4/kpis/total_collection?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`
    ];

    Promise.all(urls.map((url, index) => fetchApi(url, 'Data unavailable')))
    .then(results => {
        const production = results[0].items[0] || {total_production: 'Data unavailable'};
        const adjustedProDentists = results[1].items || [];
        const adjustedProHygienists = results[2].items || [];
        const totalCollection = results[3].items[0] || {total_collection: 'Data unavailable'};

        dashboardData.innerHTML = `
            <div class='card'>Total Production: ${production.total_production} (${production.practice_name || 'Unknown'})</div>
            <div class='card'>Adjusted Production By Dentists:<br>${adjustedProDentists.map(d => `<span>${d.firstname} ${d.lastname}: ${d.adjusted_production}</span>`).join('<br>')}</div>
            <div class='card'>Adjusted Production By Hygienists:<br>${adjustedProHygienists.map(h => `<span>${h.firstname} ${h.lastname}: ${h.adjusted_production}</span>`).join('<br>')}</div>
            <div class='card'>Total Collection: $${Math.abs(parseFloat(totalCollection.total_collection))}</div>
        `;
    })
    .catch(error => console.error('Error:', error));
}

function logout() {
    localStorage.removeItem('request_key');
    localStorage.removeItem('practice_id');
}

document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>

</body>
</html>