<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Management</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .sidebar { position: fixed; left: 0; top: 0; width: 200px; height: 100%; background: #333; color: #FFF; padding: 15px; box-shadow: 3px 0 5px rgba(0,0,0,0.1); }
        .sidebar a { color: #FFF; text-decoration: none; display: block; margin: 10px 0; }
        .main-content { margin-left: 220px; padding: 20px; }
        .card { background-color: #f2f2f2; padding: 20px; margin-bottom: 20px; border-radius: 5px; }
        input[type="date"] { margin: 0 10px; padding: 5px; }
    </style>
</head>
<body>
<div class="sidebar">
    <a href="Dashboard.html">Dashboard</a>
    <a href="PatientManagement.html">Patient Management</a>
    <a href="AppointmentandSchedulingManagement.html">Appointment & Scheduling</a>
    <a href="ClinicalPerformanceMetrics.html">Clinical Performance</a>
    <a href="Login.html" onclick="logout()">Logout</a>
</div>
<div class="main-content">
    <h2>Patient Management</h2>
    <label for="startdate">Start Date:</label>
    <input type="date" id="startdate">
    <label for="enddate">End Date:</label>
    <input type="date" id="enddate">
    <button onclick="getPatientData()">Get Data</button>
    <div id="patientData"></div>
</div>

<script>
function formatDate(date) {
    const d = new Date(date);
    return d.toISOString().split('T')[0];
}

function loadPatientData() {
    let startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    let endDate = new Date();
    document.getElementById('startdate').value = formatDate(startDate);
    document.getElementById('enddate').value = formatDate(endDate);
    getPatientData();
}

function getPatientData() {
    var startdate = document.getElementById('startdate').value;
    var enddate = document.getElementById('enddate').value;
    var practice_id = localStorage.getItem('practice_id');
    let patientData = document.getElementById('patientData');

    const urls = [
        `https://api.sikkasoft.com/v4/kpis/active_patients?practice_id=${practice_id}`,
        `https://api.sikkasoft.com/v4/kpis/new_patients?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`,
        `https://api.sikkasoft.com/v4/kpis/number_of_patients_seen?startdate=${startdate}&enddate=${enddate}&practice_id=${practice_id}`
    ];

    Promise.all(urls.map(url => fetch(url, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'Request-Key': localStorage.getItem('request_key')
        }
    }).then(response => {
        if (response.status === 204) return 'Data unavailable';
        if (response.status === 400) return 'Bad Request';
        return response.json();
    })))
    .then(results => {
        const activePatients = results[0].items ? results[0].items[0].active_patients : 'Data unavailable';
        const newPatients = results[1].items ? results[1].items[0].new_patients : 'Data unavailable';
        const totalPatientsSeen = results[2].items ? results[2].items[0].total_patients : 'Data unavailable';

        patientData.innerHTML = `
            <div class='card'>Active Patients: ${activePatients}</div>
            <div class='card'>New Patients: ${newPatients}</div>
            <div class='card'>Total Number Of Patients Seen: ${totalPatientsSeen}</div>
        `;
    })
    .catch(error => console.error('Error:', error));
}

function logout() {
    localStorage.removeItem('request_key');
    localStorage.removeItem('practice_id');
}

document.addEventListener('DOMContentLoaded', loadPatientData);
</script>

</body>
</html>