<html>
<head>
    <title>Appointments</title>
    <style>
        body { background-color: #f2f2f2; font-family: Arial, sans-serif; margin: 0; }
        .menu { width: 200px; float: left; background-color: #fff; height: 100vh; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .menu a { display: block; text-decoration: none; color: #333; padding: 15px; }
        .menu a:hover { background-color: #4CAF50; color: white; }
        .content { margin-left: 210px; padding: 20px; }
        .appointment-form { margin: 20px 0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; }
        th { background-color: #4CAF50; color: white; }
        .error { color: red; }
    </style>
</head>
<body>
    <div class="menu">
        <a href="dashboard.html">Dashboard</a>
        <a href="requested_payments.html">Requested Payments</a>
        <a href="transactions.html">Transactions</a>
        <a href="login.html">Logout</a>
    </div>
    <div class="content">
        <h1>Appointments</h1>
        <div class="appointment-form">
            Start Date: <input type="date" id="startdate" value="" onchange="loadAppointments()">
            End Date: <input type="date" id="enddate" value="" onchange="loadAppointments()">
        </div>
        <table id="appointmentTable">
            <thead>
                <tr>
                    <th>Patient Name</th>
                    <th>Guarantor Name</th>
                    <th>Amount</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <p id="error" class="error"></p>
    </div>
    <script>
        const request_key = sessionStorage.getItem('request_key');
        const practice_id = sessionStorage.getItem('selected_practice');
        const start_date = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
        const end_date = new Date().toISOString().split('T')[0];

        document.getElementById('startdate').value = start_date;
        document.getElementById('enddate').value = end_date;

        function loadAppointments() {
            const startdate = document.getElementById('startdate').value;
            const enddate = document.getElementById('enddate').value;

            fetch(`https://api.sikkasoft.com/v4/appointments?startdate=${startdate}&enddate=${enddate}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json', 'Request-Key': request_key }
            })
            .then(response => {
                if (response.status === 204) {
                    throw new Error('Data is not available for this period');
                } else if (response.status === 400) {
                    throw new Error('Bad Request');
                }
                return response.json();
            })
            .then(data => {
                const tableBody = document.getElementById('appointmentTable').querySelector('tbody');
                tableBody.innerHTML = '';
                data.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.patient_name}</td>
                        <td>${item.guarantor_name}</td>
                        <td>${item.amount}</td>
                        <td><button onclick='requestPayment(${JSON.stringify(item)})'>Request Payment</button></td>
                    `;
                    tableBody.appendChild(row);
                });
            })
            .catch(error => {
                document.getElementById('error').innerText = error.message;
            });
        }

        function requestPayment(appointment) {
            const note = prompt('Enter note:');
            const transaction_amount = prompt('Enter transaction amount:');
            const short_url = 'your_short_url'; // You need to place the real short URL.
            const payload = {
                payment_type: 'text2pay',
                practice_name: appointment.practice_name,
                provider_full_name: appointment.provider_full_name,
                patient_first_name: appointment.patient_name.split(' ')[0],
                patient_last_name: appointment.patient_name.split(' ').slice(1).join(' '),
                note: `${note} <${short_url}>`,
                practice_id: appointment.practice_id,
                patient_id: appointment.patient_id,
                guarantor_id: appointment.guarantor_id,
                provider_id: appointment.provider_id,
                cust_id: appointment.cust_id,
                transaction_amount: transaction_amount
            };
            fetch('https://api.sikkasoft.com/v4/payment/request_payment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Request-Key': request_key },
                body: JSON.stringify(payload)
            })
            .then(response => {
                if (response.status === 201) {
                    alert('Payment requested successfully');
                } else {
                    alert('Failed to request payment');
                }
            })
            .catch(error => {
                alert('An error occurred');
            });
        }

        loadAppointments();
    </script>
</body>
</html>